<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To-Do API</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Header fixo -->
    <header>
      <h1>üöÄ To-Do API</h1>
      <nav>
        <a href="#sobre">Sobre</a>
        <a href="#features">Recursos</a>
        <a href="#api">API</a>
        <button onclick="logout()" id="logoutBtn" style="display: none">
          Logout
        </button>
      </nav>
    </header>

    <!-- Hero -->
    <section class="hero">
      <h2>Gerencie suas tarefas com facilidade</h2>
      <p>API REST simples com Node.js, Express e PostgreSQL</p>
    </section>

    <!-- Login -->
    <section class="login-section">
      <h2>Login</h2>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Senha" />
      <button onclick="login()">Entrar</button>
    </section>

    <!-- Container centralizado das tarefas -->
    <section class="task-container" style="display: none">
      <!-- Adicionar Tarefa -->
      <div class="task-section">
        <h2>Adicionar Tarefa</h2>
        <div class="form">
          <input id="title" placeholder="T√≠tulo" />
          <input id="description" placeholder="Descri√ß√£o" />
          <button onclick="addTask()">Adicionar</button>
        </div>
      </div>

      <!-- Lista de Tarefas -->
      <div class="api-section">
        <h2>Minhas Tarefas</h2>
        <ul id="tasks"></ul>
      </div>
    </section>

    <!-- Grid de recursos -->
    <section id="features" class="grid">
      <div class="card">üìå Criar tarefas</div>
      <div class="card">üìã Listar tarefas</div>
      <div class="card">‚úèÔ∏è Atualizar & üóëÔ∏è Excluir</div>
    </section>

    <section
      class="users-container"
      style="
        display: none;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
        padding: 0 1rem;
      "
    >
      <div class="users-section">
        <h2>Gerenciar Usu√°rios</h2>
        <div class="form">
          <input id="userName" placeholder="Nome" />
          <input id="userEmail" placeholder="Email" />
          <input id="userPassword" type="password" placeholder="Senha" />
          <select id="userRole">
            <option value="viewer">Viewer</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
          <button onclick="addUser()">Criar Usu√°rio</button>
        </div>
      </div>

      <div class="api-section">
        <h2>Usu√°rios</h2>
        <ul id="users"></ul>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <p>Feito para treinar rotas REST | 2025</p>
    </footer>

    <script>
      // Fun√ß√£o de login
      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const res = await fetch("http://localhost:3000/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) return alert("Email ou senha inv√°lidos");

        const data = await res.json();
        localStorage.setItem("token", data.token);
        localStorage.setItem("role", data.user.role);
        localStorage.setItem("userId", data.user.id); // salva o id do usu√°rio logado

        document.querySelector(".login-section").style.display = "none";
        document.querySelector(".task-container").style.display = "flex";
        document.getElementById("logoutBtn").style.display = "inline-block";

        loadTasks();
        checkAdmin();
      }

      // Fun√ß√£o de logout
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        localStorage.removeItem("userId");
        document.querySelector(".login-section").style.display = "block";
        document.querySelector(".task-container").style.display = "none";
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("tasks").innerHTML = "";
        window.location.reload();
      }

      // Fun√ß√£o para carregar tarefas
      async function loadTasks() {
        const token = localStorage.getItem("token");
        if (!token) return;

        const res = await fetch("http://localhost:3000/tasks", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const tasks = await res.json();
        const list = document.getElementById("tasks");

        const role = localStorage.getItem("role");
        list.innerHTML = tasks
          .map((t) => {
            const canDelete = role === "admin" || role === "manager";
            return `
      <li>
        <strong>${t.title}</strong> - <em>${t.status}</em>
        <p>${t.description || "Sem descri√ß√£o"}</p>
        <button onclick="updateStatus(${t.id}, '${
              t.status
            }')">Alternar Status</button>
        ${
          canDelete
            ? `<button onclick="deleteTask(${t.id})">Excluir</button>`
            : ""
        }
      </li>
    `;
          })
          .join("");
        checkAdmin();
      }

      // Fun√ß√£o para adicionar tarefa
      async function addTask() {
        const token = localStorage.getItem("token");
        if (!token) return;

        const title = document.getElementById("title").value;
        const desc = document.getElementById("description").value;

        await fetch("http://localhost:3000/tasks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ title, description: desc }),
        });

        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        loadTasks();
      }

      // Atualizar status da tarefa
      async function updateStatus(id, currentStatus) {
        const token = localStorage.getItem("token");
        if (!token) return;

        const newStatus =
          currentStatus === "pendente" ? "conclu√≠da" : "pendente";
        await fetch(`http://localhost:3000/tasks/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ status: newStatus }),
        });

        loadTasks();
      }

      // Excluir tarefa
      async function deleteTask(id) {
        const token = localStorage.getItem("token");
        if (!token) return;

        await fetch(`http://localhost:3000/tasks/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });

        loadTasks();
      }

      // Carregar usu√°rios (apenas admin)
      async function loadUsers() {
        const token = localStorage.getItem("token");
        if (!token) return;

        const res = await fetch("http://localhost:3000/users", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const users = await res.json();
        const list = document.getElementById("users");

        const currentUserId = parseInt(localStorage.getItem("userId")); // id do usu√°rio logado

        list.innerHTML = users
          .map((u) => {
            const canDelete = u.id !== currentUserId; // n√£o pode deletar a si mesmo
            return `
        <li>
          <strong>${u.name}</strong> (<em>${u.email}</em>) 
          - <span class="role-label ${u.role.toUpperCase()}">${u.role.toUpperCase()}</span>
          ${
            canDelete
              ? `<button onclick="deleteUser(${u.id})">Excluir</button>`
              : ""
          }
        </li>
      `;
          })
          .join("");
      }

      // Criar usu√°rio
      async function addUser() {
        const token = localStorage.getItem("token");
        if (!token) return;

        const name = document.getElementById("userName").value;
        const email = document.getElementById("userEmail").value;
        const password = document.getElementById("userPassword").value;
        const role = document.getElementById("userRole").value;

        await fetch("http://localhost:3000/users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ name, email, password, role }),
        });

        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userPassword").value = "";
        loadUsers();
      }

      // Deletar usu√°rio
      async function deleteUser(id) {
        const token = localStorage.getItem("token");
        if (!token) return;

        await fetch(`http://localhost:3000/users/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });

        loadUsers();
      }

      // Mostrar √°rea de admin se role for "admin"
      function checkAdmin() {
        const role = localStorage.getItem("role");
        if (role === "admin") {
          document.querySelector(".users-container").style.display = "flex";
          loadUsers();
        }
      }

      // Carrega tarefas automaticamente se j√° estiver logado
      if (localStorage.getItem("token")) {
        document.querySelector(".login-section").style.display = "none";
        document.querySelector(".task-container").style.display = "flex";
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadTasks();
      }
    </script>
  </body>
</html>
